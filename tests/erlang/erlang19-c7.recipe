# Bibop recipe for Erlang 19
# See more: https://kaos.sh/bibop

pkg erlang19

var epmd_service epmd
var epmd_port    4369

var delay 3

command "-" "Check environment"
  app epmd
  app erl
  app erlc
  app escript

  service-present {epmd_service}

command "-" "Check zlib linking"
  !lib-linked {ERLANG_BIN_DIR}/beam.smp libz.so.1

command "erl -compile test" "Compile basic script"
  exit 0
  exist test.beam

command "erl -noshell -s test main -s init stop" "Execute basic script"
  exit 0
  output-contains "ERLANG WORKS"

command "systemctl start {epmd_service}" "Start Erlang Port Mapper Daemon"
  wait {delay}
  service-works {epmd_service}

command "systemctl status {epmd_service}" "Check status of Erlang Port Mapper Daemon"
  expect "active (running)"
  connect tcp :{epmd_port}

command "systemctl stop {epmd_service}" "Stop HAProxy daemon"
  wait {delay}
  !service-works {epmd_service}
  !connect tcp :{epmd_port}
